package com.example.demo.controller;

import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessageHeaderAccessor;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

import com.example.demo.dto.ObjectState;
import com.example.demo.dto.PlayerHitMessage;
import com.example.demo.dto.PlayerState;
import com.example.demo.service.PlayerService;

@Controller
public class GameController {

	private static final Logger logger = LoggerFactory.getLogger(GameController.class);
	private final SimpMessagingTemplate messagingTemplate;
	private final PlayerService playerService;

	public GameController(SimpMessagingTemplate messagingTemplate, PlayerService playerService) {
		this.messagingTemplate = messagingTemplate;
		this.playerService = playerService;
	}

	@GetMapping("/api/hello")
	public String hello() {
		//logger.info("Hello from Spring Boot server (HTTP request)!");
		return "Hello from Spring Boot!";
	}

	@MessageMapping("/registerPlayer")
	public void registerPlayer(PlayerState playerState, SimpMessageHeaderAccessor headerAccessor) {
		String sessionId = headerAccessor.getSessionId();
		playerState.setSessionId(sessionId); // ì„¸ì…˜ ID ì„¤ì •

		playerService.addPlayer(playerState, sessionId); // í”Œë ˆì´ì–´ ì¶”ê°€/ì—…ë°ì´íŠ¸
		//logger.info("Player registered: {} (Session: {})", playerState.getId(), sessionId);

		// ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ í˜„ì¬ í”Œë ˆì´ì–´ ëª©ë¡ ë¸Œë¡œë“œìºìŠ¤íŒ…
		//logger.info("Broadcasting player locations after register. Total players: {}",
				//playerService.getAllPlayers().size());
		messagingTemplate.convertAndSend("/topic/playerLocations", playerService.getAllPlayers());
	}

	/**
	 * í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° í”Œë ˆì´ì–´ì˜ ì´ë™ ìƒíƒœ ë° ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ê³ , ì´ë¥¼ ë‹¤ë¥¸ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŒ…í•©ë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ”
	 * í´ë¼ì´ì–¸íŠ¸ì˜ STOMP ë©”ì‹œì§€ Destinationì´ "/app/playerMove"ì¼ ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤.
	 *
	 * @param playerState    ì—…ë°ì´íŠ¸ëœ í”Œë ˆì´ì–´ ìƒíƒœ (ID, ìœ„ì¹˜, íšŒì „, ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ë“± í¬í•¨)
	 * @param headerAccessor STOMP ë©”ì‹œì§€ í—¤ë” ì ‘ê·¼ì (ì„¸ì…˜ ID ë“± ì •ë³´ ì¶”ì¶œ ê°€ëŠ¥)
	 */
	@MessageMapping("/playerMove")
	public void playerMove(PlayerState playerState, SimpMessageHeaderAccessor headerAccessor) {

		playerService.updatePlayerState(playerState.getId(), playerState.getPosition(), playerState.getRotationY(),
				playerState.getAnimationState() // <-- ì´ ë¶€ë¶„ì´ ìƒˆë¡œ ì¶”ê°€ë©ë‹ˆë‹¤!
		);
		// logger.debug("Player moved: {} at ({}, {}, {})", playerState.getId(),
		// playerState.getPosition().getX(), playerState.getPosition().getY(),
		// playerState.getPosition().getZ());

		
		// ì—…ë°ì´íŠ¸ëœ ì „ì²´ í”Œë ˆì´ì–´ ëª©ë¡ì„ ë‹¤ì‹œ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŒ…í•©ë‹ˆë‹¤.
		messagingTemplate.convertAndSend("/topic/playerLocations", playerService.getAllPlayers());
	}
	
	@MessageMapping("/sceneObjects")
	public void updateObjectState(List<ObjectState> objectStates) {
	    // ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
		
		
	    messagingTemplate.convertAndSend("/topic/sceneObjects", objectStates);
	}
	
	@MessageMapping("/playerHit")
	public void handlePlayerHit(PlayerHitMessage message) {
	    logger.info("ğŸ’¥ Player Hit Received â†’ From: {}, To: {}", message.getFromId(), message.getTargetId());
	    // ë¸Œë¡œë“œìºìŠ¤íŠ¸: ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ í”¼ê²© ì•Œ ìˆ˜ ìˆë„ë¡
	    messagingTemplate.convertAndSend("/topic/playerHit", message);
	}




	/**
	 * ì›¹ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì¡Œì„ ë•Œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ. ì´ ë©”ì„œë“œëŠ” WebSocketEventListenerì˜
	 * SessionDisconnectEventì—ì„œ í˜¸ì¶œë©ë‹ˆë‹¤.
	 *
	 * @param sessionId ì—°ê²°ì´ ëŠê¸´ ì„¸ì…˜ì˜ ID
	 */
	public void unregisterPlayer(String sessionId) {
		playerService.removePlayerBySessionId(sessionId);
		//logger.info("Player unregistered (session disconnected): Session: {}. Remaining players: {}", sessionId,
			//	playerService.getAllPlayers().size());
		// í”Œë ˆì´ì–´ ì œê±° í›„, ì—…ë°ì´íŠ¸ëœ í”Œë ˆì´ì–´ ëª©ë¡ì„ ë¸Œë¡œë“œìºìŠ¤íŒ…
		messagingTemplate.convertAndSend("/topic/playerLocations", playerService.getAllPlayers());
	}
}