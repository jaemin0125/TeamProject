package com.example.demo.service;

import com.example.demo.dto.PlayerState;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import java.util.Collection;
import java.util.concurrent.ConcurrentHashMap;
import java.util.Map;

@Service
public class PlayerService {

    private static final Logger logger = LoggerFactory.getLogger(PlayerService.class);

    private final Map<String, PlayerState> connectedPlayers = new ConcurrentHashMap<>();
    private final Map<String, String> sessionToPlayerIdMap = new ConcurrentHashMap<>();

    /**
     * ìƒˆë¡œìš´ í”Œë ˆì´ì–´ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜, ê¸°ì¡´ í”Œë ˆì´ì–´ì˜ ì„¸ì…˜ ID ë° ì´ˆê¸° ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * í´ë¼ì´ì–¸íŠ¸ì˜ `id`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í”Œë ˆì´ì–´ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.
     *
     * @param playerState ë“±ë¡í•  í”Œë ˆì´ì–´ì˜ ìƒíƒœ (ID, ì´ˆê¸° ìœ„ì¹˜, ë‹‰ë„¤ì„ ë“±)
     * @param sessionId í˜„ì¬ ì—°ê²°ì˜ ì„¸ì…˜ ID
     */
    public void addPlayer(PlayerState playerState, String sessionId) {
        if (playerState.getId() == null || playerState.getId().isEmpty()) {
            logger.error("[PlayerService] Attempted to add player with null or empty ID.");
            return;
        }

        // ğŸš¨ ê°€ì¥ ì¤‘ìš”: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì€ playerStateì˜ ë‹‰ë„¤ì„ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
        logger.info("[PlayerService] Adding/Updating player: ID={}, Nickname='{}', Session={}",
                playerState.getId(), playerState.getNickname(), sessionId);

        // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”Œë ˆì´ì–´ì¸ì§€ í™•ì¸ (í´ë¼ì´ì–¸íŠ¸ ID ê¸°ì¤€)
        if (connectedPlayers.containsKey(playerState.getId())) {
            // í”Œë ˆì´ì–´ê°€ ì´ë¯¸ ì¡´ì¬í•œë‹¤ë©´, ì„¸ì…˜ ID ë° ìµœì‹  ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
            PlayerState existingPlayer = connectedPlayers.get(playerState.getId());
            String oldSessionId = existingPlayer.getSessionId();

            // ê¸°ì¡´ ì„¸ì…˜ ë§¤í•‘ ì œê±° (ë§Œì•½ ì´ì „ ì„¸ì…˜ IDê°€ ë‹¤ë¥´ê³  ìœ íš¨í•˜ë‹¤ë©´)
            if (oldSessionId != null && !oldSessionId.equals(sessionId) && sessionToPlayerIdMap.containsKey(oldSessionId)) {
                sessionToPlayerIdMap.remove(oldSessionId);
                logger.debug("[PlayerService] Removed old session mapping for player {}: {}", playerState.getId(), oldSessionId);
            }

            // í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ (ìœ„ì¹˜, íšŒì „, ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ë“± í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ìµœì‹  ê°’ìœ¼ë¡œ)
            existingPlayer.setSessionId(sessionId);
            existingPlayer.setPosition(playerState.getPosition());
            existingPlayer.setRotationY(playerState.getRotationY());
            existingPlayer.setAnimationState(playerState.getAnimationState());
            // ğŸš¨ğŸš¨ğŸš¨ ì—¬ê¸°! ê¸°ì¡´ í”Œë ˆì´ì–´ì— ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
            // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‹‰ë„¤ì„ì„ ê³„ì† ë³´ë‚´ë¯€ë¡œ, ì—¬ê¸°ì—ì„œ ì—…ë°ì´íŠ¸í•´ì£¼ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.
            existingPlayer.setNickname(playerState.getNickname());

            logger.info("[PlayerService] Player {} re-registered and updated with new session {}. Old session: {}. Current nickname: {}",
                    playerState.getId(), sessionId, oldSessionId, existingPlayer.getNickname());
        } else {
            // ìƒˆë¡œìš´ í”Œë ˆì´ì–´ë¼ë©´ ì¶”ê°€
            playerState.setSessionId(sessionId);
            // ğŸš¨ playerStateëŠ” ì´ë¯¸ ë‹‰ë„¤ì„ì„ í¬í•¨í•˜ê³  ìˆìœ¼ë¯€ë¡œ, ì´ ê°ì²´ ìì²´ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
            connectedPlayers.put(playerState.getId(), playerState);
            logger.info("[PlayerService] New player {} added with session {}. Nickname: {}",
                    playerState.getId(), sessionId, playerState.getNickname());
        }
        
        // ì„¸ì…˜ IDì™€ í”Œë ˆì´ì–´ ID ë§¤í•‘ì„ í•­ìƒ ìµœì‹ ìœ¼ë¡œ ìœ ì§€
        if (sessionId != null) {
            sessionToPlayerIdMap.put(sessionId, playerState.getId());
            logger.debug("[PlayerService] Session-PlayerId map updated: {} -> {}", sessionId, playerState.getId());
        }
        logger.debug("[PlayerService] Player count after add/update: {}", connectedPlayers.size());
    }

    /**
     * íŠ¹ì • í”Œë ˆì´ì–´ì˜ ëª¨ë“  ìƒíƒœ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * ì´ ë©”ì„œë“œëŠ” ì´ì œ PlayerState ì „ì²´ë¥¼ ì¸ìë¡œ ë°›ì•„ í•„ìš”í•œ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     *
     * @param updatedPlayerState ì—…ë°ì´íŠ¸í•  í”Œë ˆì´ì–´ì˜ ìµœì‹  ìƒíƒœ ê°ì²´ (ID, ìœ„ì¹˜, íšŒì „, ì• ë‹ˆë©”ì´ì…˜, ë‹‰ë„¤ì„ ë“± í¬í•¨)
     */
    // ğŸš¨ğŸš¨ğŸš¨ ì´ ë©”ì„œë“œì˜ ì‹œê·¸ë‹ˆì²˜ë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤!
    // public void updatePlayerState(String playerId, PlayerState.Position newPosition, double newRotationY, AnimationState newAnimationState) {
    public void updatePlayerState(PlayerState updatedPlayerState) {
        if (updatedPlayerState == null || updatedPlayerState.getId() == null) {
            logger.warn("[PlayerService] Attempted to update with null player state or ID.");
            return;
        }

        PlayerState player = connectedPlayers.get(updatedPlayerState.getId());
        if (player != null) {
            // ğŸš¨ ì—¬ê¸°ì„œ ë‹‰ë„¤ì„ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            player.setNickname(updatedPlayerState.getNickname());
            player.setPosition(updatedPlayerState.getPosition());
            player.setRotationY(updatedPlayerState.getRotationY());
            player.setAnimationState(updatedPlayerState.getAnimationState());
            logger.debug("[PlayerService] Updated player {} state (Nickname: {}, pos: {}, rotY: {}, anim: {})",
                    updatedPlayerState.getId(), player.getNickname(), updatedPlayerState.getPosition(),
                    updatedPlayerState.getRotationY(), updatedPlayerState.getAnimationState());
        } else {
            logger.warn("[PlayerService] Attempted to update non-existent player: {}", updatedPlayerState.getId());
            // ë§Œì•½ ì´ë™ ë©”ì‹œì§€ê°€ ë¨¼ì € ë„ì°©í–ˆëŠ”ë° ë“±ë¡ë˜ì§€ ì•Šì€ í”Œë ˆì´ì–´ë¼ë©´, ì—¬ê¸°ì„œ ì¶”ê°€í•˜ëŠ” ë¡œì§ì„ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // connectedPlayers.put(updatedPlayerState.getId(), updatedPlayerState);
        }
    }

    /**
     * íŠ¹ì • í”Œë ˆì´ì–´ IDë¥¼ í†µí•´ í”Œë ˆì´ì–´ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
     *
     * @param playerId ì œê±°í•  í”Œë ˆì´ì–´ì˜ ê³ ìœ  ID
     */
    public void removePlayerById(String playerId) {
        if (playerId != null) {
            PlayerState removedPlayer = connectedPlayers.remove(playerId);
            if (removedPlayer != null) {
                sessionToPlayerIdMap.entrySet().removeIf(entry -> entry.getValue().equals(playerId));
                logger.info("[PlayerService] Player removed by ID: {}. Remaining: {}", playerId, connectedPlayers.size());
            } else {
                logger.warn("[PlayerService] Attempted to remove non-existent player by ID: {}", playerId);
            }
        }
    }

    /**
     * ì—°ê²°ì´ ëŠê¸´ ì„¸ì…˜ IDë¥¼ í†µí•´ í”Œë ˆì´ì–´ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
     * ì´ ë©”ì„œë“œëŠ” ì£¼ë¡œ WebSocketEventListenerì—ì„œ ì„¸ì…˜ ë‹¨ì ˆ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤.
     *
     * @param sessionId ì œê±°í•  ì„¸ì…˜ì˜ ID
     */
    public void removePlayerBySessionId(String sessionId) {
        if (sessionId != null) {
            String playerId = sessionToPlayerIdMap.remove(sessionId); // ì„¸ì…˜ IDë¡œ í”Œë ˆì´ì–´ ID ì°¾ì•„ì„œ ë§¤í•‘ ì œê±°
            if (playerId != null) {
                connectedPlayers.remove(playerId); // í”Œë ˆì´ì–´ IDë¡œ í”Œë ˆì´ì–´ ìƒíƒœ ì œê±°
                logger.info("[PlayerService] Player removed by Session ID: {} (Player ID: {}). Remaining: {}", sessionId, playerId, connectedPlayers.size());
            } else {
                logger.warn("[PlayerService] Attempted to remove player for non-existent session: {}", sessionId);
            }
        }
    }

    /**
     * í˜„ì¬ ì—°ê²°ëœ ëª¨ë“  í”Œë ˆì´ì–´ì˜ ìƒíƒœë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     *
     * @return ëª¨ë“  í”Œë ˆì´ì–´ ìƒíƒœ ê°ì²´ì˜ ì»¬ë ‰ì…˜
     */
    public Collection<PlayerState> getAllPlayers() {
        return connectedPlayers.values();
    }

    /**
     * ì£¼ì–´ì§„ ì„¸ì…˜ IDì— í•´ë‹¹í•˜ëŠ” í”Œë ˆì´ì–´ì˜ IDë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     *
     * @param sessionId ì¡°íšŒí•  ì„¸ì…˜ì˜ ID
     * @return í”Œë ˆì´ì–´ ID, ì—†ìœ¼ë©´ null
     */
    public String getPlayerIdBySessionId(String sessionId) {
        return sessionToPlayerIdMap.get(sessionId);
    }
}